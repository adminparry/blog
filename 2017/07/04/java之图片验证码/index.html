

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    
    
    <meta name="author" content="parry">
    
    <meta name="description" content="图片验证码是一般常用在注册登录页面的功能，在一定程度上能减少用户的恶意注册，恶意登录行为，所以在一定程度上还是起了一定的作用的，当然还有别的场景也需要，总而言之是有必要的是需要会做的
验证码工具类1234567891011121314151617181920212223242526272829303">
    
    

    
    <link rel="alternative" href="YOUR_RSS_ADDRESS" title="parry" type="application/atom+xml">
    
    
    <link rel="icon" href="/blog/favicon.png">
    
    

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>java之图片验证码 | parry</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/blog/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/blog/css/style.css">

    <!-- Javascript -->
    <script src="/blog/js/jquery-2.1.0.min.js"></script>
    
    <script src="/blog/bootstrap/js/bootstrap.min.js"></script>

    <script src="/blog/js/common.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-inverse" role="banner">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a target="_blank" class="navbar-brand" href="http://code-helloworld.com" title="parry">parry</a>

            
            </div>

            <div role="navigation" class="collapse navbar-collapse bs-navbar-collapse">
                
                <a id="search" href="javascript:" class="navbar-text pull-right">搜索</a>
                <ul class="nav navbar-nav">
                    
                    <li id="nav-index"><a href="/blog">首页</a></li>
                    
                    <li id="nav-archives"><a href="/blog/archives">归档</a></li>
                    
                    
                    <li><a href="https://github.com/adminparry" target="_blank">GitHub</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div style="width:100%;height:100%;background:white;display:none;">
 
    </div>
    <script>
    var backRoot = "/blog/images/background/";
    var backArray = [ "1.jpg", "2.jpg", "3.jpg",  ];
        
    $(function() {
        // page-id...
        var pageId = "2017/07/04/java之图片验证码/";
        pageId = pageId.substr(0, pageId.indexOf("/"));
        if(pageId === "") pageId = "index";
        
        $("#nav-" + pageId).addClass("active");
        $('#search').click(function(){

        })
    });
    </script>

    <article class="post container">
    <div class="well post-body first-post last-post">
        <h1>java之图片验证码</h1>
        
        <div class="time-info">
发表于:<time datetime="2017-07-04T03:16:56.702Z" itemprop="datePublished">2017-07-04</time>，更新于:<time datetime="2017-07-04T07:23:41.693Z" itemprop="dateModified">2017-07-04</time>，By <a href="http://code-helloworld.com" title="parry">parry</a>
        </div>
        
        <div class="post-body-inner">
            <div id="toc" class="toc-article well">
                <strong class="toc-title">大纲</strong>
                <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#验证码工具类"><span class="toc-number">1.</span> <span class="toc-text">验证码工具类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用servlet实现图片验证码"><span class="toc-number">2.</span> <span class="toc-text">使用servlet实现图片验证码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用spring实现图片验证码"><span class="toc-number">3.</span> <span class="toc-text">使用spring实现图片验证码</span></a></li></ol>
            </div>
            <div class="description">

            <p>图片验证码是一般常用在注册登录页面的功能，在一定程度上能减少用户的恶意注册，恶意登录行为，所以在一定程度上还是起了一定的作用的，当然还有别的场景也需要，总而言之是有必要的是需要会做的</p>
<h3 id="验证码工具类"><a href="#验证码工具类" class="headerlink" title="验证码工具类"></a>验证码工具类</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br></pre></td><td class="code"><pre><span class="line">package com.utils;</span><br><span class="line"></span><br><span class="line">import java.awt.Color;  </span><br><span class="line">import java.awt.Font;  </span><br><span class="line">import java.awt.Graphics;  </span><br><span class="line">import java.awt.Graphics2D;  </span><br><span class="line">import java.awt.RenderingHints;  </span><br><span class="line">import java.awt.geom.AffineTransform;  </span><br><span class="line">import java.awt.image.BufferedImage;  </span><br><span class="line">import java.io.File;  </span><br><span class="line">import java.io.FileOutputStream;  </span><br><span class="line">import java.io.IOException;  </span><br><span class="line">import java.io.OutputStream;  </span><br><span class="line">import java.util.Arrays;  </span><br><span class="line">import java.util.Random;  </span><br><span class="line">  </span><br><span class="line">import javax.imageio.ImageIO;  </span><br><span class="line">  </span><br><span class="line">public class VerifyCodeUtils&#123;  </span><br><span class="line">  </span><br><span class="line">    //使用到Algerian字体，系统里没有的话需要安装字体，字体只显示大写，去掉了1,0,i,o几个容易混淆的字符  </span><br><span class="line">    public static final String VERIFY_CODES = <span class="string">"23456789ABCDEFGHJKLMNPQRSTUVWXYZ"</span>;  </span><br><span class="line">    private static Random random = new Random();  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    /** </span><br><span class="line">     * 使用系统默认字符源生成验证码 </span><br><span class="line">     * @param verifySize    验证码长度 </span><br><span class="line">     * @<span class="built_in">return</span> </span><br><span class="line">     */  </span><br><span class="line">    public static String generateVerifyCode(int verifySize)&#123;  </span><br><span class="line">        <span class="built_in">return</span> generateVerifyCode(verifySize, VERIFY_CODES);  </span><br><span class="line">    &#125;  </span><br><span class="line">    /** </span><br><span class="line">     * 使用指定源生成验证码 </span><br><span class="line">     * @param verifySize    验证码长度 </span><br><span class="line">     * @param sources   验证码字符源 </span><br><span class="line">     * @<span class="built_in">return</span> </span><br><span class="line">     */  </span><br><span class="line">    public static String generateVerifyCode(int verifySize, String sources)&#123;  </span><br><span class="line">        <span class="keyword">if</span>(sources == null || sources.length() == 0)&#123;  </span><br><span class="line">            sources = VERIFY_CODES;  </span><br><span class="line">        &#125;  </span><br><span class="line">        int codesLen = sources.length();  </span><br><span class="line">        Random rand = new Random(System.currentTimeMillis());  </span><br><span class="line">        StringBuilder verifyCode = new StringBuilder(verifySize);  </span><br><span class="line">        <span class="keyword">for</span>(int i = 0; i &lt; verifySize; i++)&#123;  </span><br><span class="line">            verifyCode.append(sources.charAt(rand.nextInt(codesLen-1)));  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="built_in">return</span> verifyCode.toString();  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    /** </span><br><span class="line">     * 生成随机验证码文件,并返回验证码值 </span><br><span class="line">     * @param w </span><br><span class="line">     * @param h </span><br><span class="line">     * @param outputFile </span><br><span class="line">     * @param verifySize </span><br><span class="line">     * @<span class="built_in">return</span> </span><br><span class="line">     * @throws IOException </span><br><span class="line">     */  </span><br><span class="line">    public static String outputVerifyImage(int w, int h, File outputFile, int verifySize) throws IOException&#123;  </span><br><span class="line">        String verifyCode = generateVerifyCode(verifySize);  </span><br><span class="line">        outputImage(w, h, outputFile, verifyCode);  </span><br><span class="line">        <span class="built_in">return</span> verifyCode;  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    /** </span><br><span class="line">     * 输出随机验证码图片流,并返回验证码值 </span><br><span class="line">     * @param w </span><br><span class="line">     * @param h </span><br><span class="line">     * @param os </span><br><span class="line">     * @param verifySize </span><br><span class="line">     * @<span class="built_in">return</span> </span><br><span class="line">     * @throws IOException </span><br><span class="line">     */  </span><br><span class="line">    public static String outputVerifyImage(int w, int h, OutputStream os, int verifySize) throws IOException&#123;  </span><br><span class="line">        String verifyCode = generateVerifyCode(verifySize);  </span><br><span class="line">        outputImage(w, h, os, verifyCode);  </span><br><span class="line">        <span class="built_in">return</span> verifyCode;  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    /** </span><br><span class="line">     * 生成指定验证码图像文件 </span><br><span class="line">     * @param w </span><br><span class="line">     * @param h </span><br><span class="line">     * @param outputFile </span><br><span class="line">     * @param code </span><br><span class="line">     * @throws IOException </span><br><span class="line">     */  </span><br><span class="line">    public static void outputImage(int w, int h, File outputFile, String code) throws IOException&#123;  </span><br><span class="line">        <span class="keyword">if</span>(outputFile == null)&#123;  </span><br><span class="line">            <span class="built_in">return</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        File dir = outputFile.getParentFile();  </span><br><span class="line">        <span class="keyword">if</span>(!dir.exists())&#123;  </span><br><span class="line">            dir.mkdirs();  </span><br><span class="line">        &#125;  </span><br><span class="line">        try&#123;  </span><br><span class="line">            outputFile.createNewFile();  </span><br><span class="line">            FileOutputStream fos = new FileOutputStream(outputFile);  </span><br><span class="line">            outputImage(w, h, fos, code);  </span><br><span class="line">            fos.close();  </span><br><span class="line">        &#125; catch(IOException e)&#123;  </span><br><span class="line">            throw e;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    /** </span><br><span class="line">     * 输出指定验证码图片流 </span><br><span class="line">     * @param w </span><br><span class="line">     * @param h </span><br><span class="line">     * @param os </span><br><span class="line">     * @param code </span><br><span class="line">     * @throws IOException </span><br><span class="line">     */  </span><br><span class="line">    public static void outputImage(int w, int h, OutputStream os, String code) throws IOException&#123;  </span><br><span class="line">        int verifySize = code.length();  </span><br><span class="line">        BufferedImage image = new BufferedImage(w, h, BufferedImage.TYPE_INT_RGB);  </span><br><span class="line">        Random rand = new Random();  </span><br><span class="line">        Graphics2D g2 = image.createGraphics();  </span><br><span class="line">        g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING,RenderingHints.VALUE_ANTIALIAS_ON);  </span><br><span class="line">        Color[] colors = new Color[5];  </span><br><span class="line">        Color[] colorSpaces = new Color[] &#123; Color.WHITE, Color.CYAN,  </span><br><span class="line">                Color.GRAY, Color.LIGHT_GRAY, Color.MAGENTA, Color.ORANGE,  </span><br><span class="line">                Color.PINK, Color.YELLOW &#125;;  </span><br><span class="line">        <span class="built_in">float</span>[] fractions = new <span class="built_in">float</span>[colors.length];  </span><br><span class="line">        <span class="keyword">for</span>(int i = 0; i &lt; colors.length; i++)&#123;  </span><br><span class="line">            colors[i] = colorSpaces[rand.nextInt(colorSpaces.length)];  </span><br><span class="line">            fractions[i] = rand.nextFloat();  </span><br><span class="line">        &#125;  </span><br><span class="line">        Arrays.sort(fractions);  </span><br><span class="line">          </span><br><span class="line">        g2.setColor(Color.GRAY);// 设置边框色  </span><br><span class="line">        g2.fillRect(0, 0, w, h);  </span><br><span class="line">          </span><br><span class="line">        Color c = getRandColor(200, 250);  </span><br><span class="line">        g2.setColor(c);// 设置背景色  </span><br><span class="line">        g2.fillRect(0, 2, w, h-4);  </span><br><span class="line">          </span><br><span class="line">        //绘制干扰线  </span><br><span class="line">        Random random = new Random();  </span><br><span class="line">        g2.setColor(getRandColor(160, 200));// 设置线条的颜色  </span><br><span class="line">        <span class="keyword">for</span> (int i = 0; i &lt; 20; i++) &#123;  </span><br><span class="line">            int x = random.nextInt(w - 1);  </span><br><span class="line">            int y = random.nextInt(h - 1);  </span><br><span class="line">            int xl = random.nextInt(6) + 1;  </span><br><span class="line">            int yl = random.nextInt(12) + 1;  </span><br><span class="line">            g2.drawLine(x, y, x + xl + 40, y + yl + 20);  </span><br><span class="line">        &#125;  </span><br><span class="line">          </span><br><span class="line">        // 添加噪点  </span><br><span class="line">        <span class="built_in">float</span> yawpRate = 0.05f;// 噪声率  </span><br><span class="line">        int area = (int) (yawpRate * w * h);  </span><br><span class="line">        <span class="keyword">for</span> (int i = 0; i &lt; area; i++) &#123;  </span><br><span class="line">            int x = random.nextInt(w);  </span><br><span class="line">            int y = random.nextInt(h);  </span><br><span class="line">            int rgb = getRandomIntColor();  </span><br><span class="line">            image.setRGB(x, y, rgb);  </span><br><span class="line">        &#125;  </span><br><span class="line">          </span><br><span class="line">        shear(g2, w, h, c);// 使图片扭曲  </span><br><span class="line">  </span><br><span class="line">        g2.setColor(getRandColor(100, 160));  </span><br><span class="line">        int fontSize = h-4;  </span><br><span class="line">        Font font = new Font(<span class="string">"Algerian"</span>, Font.ITALIC, fontSize);  </span><br><span class="line">        g2.setFont(font);  </span><br><span class="line">        char[] chars = code.toCharArray();  </span><br><span class="line">        <span class="keyword">for</span>(int i = 0; i &lt; verifySize; i++)&#123;  </span><br><span class="line">            AffineTransform affine = new AffineTransform();  </span><br><span class="line">            affine.setToRotation(Math.PI / 4 * rand.nextDouble() * (rand.nextBoolean() ? 1 : -1), (w / verifySize) * i + fontSize/2, h/2);  </span><br><span class="line">            g2.setTransform(affine);  </span><br><span class="line">            g2.drawChars(chars, i, 1, ((w-10) / verifySize) * i + 5, h/2 + fontSize/2 - 10);  </span><br><span class="line">        &#125;  </span><br><span class="line">          </span><br><span class="line">        g2.dispose();  </span><br><span class="line">        ImageIO.write(image, <span class="string">"jpg"</span>, os);  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    private static Color getRandColor(int <span class="built_in">fc</span>, int bc) &#123;  </span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">fc</span> &gt; 255)  </span><br><span class="line">            <span class="built_in">fc</span> = 255;  </span><br><span class="line">        <span class="keyword">if</span> (bc &gt; 255)  </span><br><span class="line">            bc = 255;  </span><br><span class="line">        int r = <span class="built_in">fc</span> + random.nextInt(bc - <span class="built_in">fc</span>);  </span><br><span class="line">        int g = <span class="built_in">fc</span> + random.nextInt(bc - <span class="built_in">fc</span>);  </span><br><span class="line">        int b = <span class="built_in">fc</span> + random.nextInt(bc - <span class="built_in">fc</span>);  </span><br><span class="line">        <span class="built_in">return</span> new Color(r, g, b);  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    private static int <span class="function"><span class="title">getRandomIntColor</span></span>() &#123;  </span><br><span class="line">        int[] rgb = getRandomRgb();  </span><br><span class="line">        int color = 0;  </span><br><span class="line">        <span class="keyword">for</span> (int c : rgb) &#123;  </span><br><span class="line">            color = color &lt;&lt; 8;  </span><br><span class="line">            color = color | c;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="built_in">return</span> color;  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    private static int[] <span class="function"><span class="title">getRandomRgb</span></span>() &#123;  </span><br><span class="line">        int[] rgb = new int[3];  </span><br><span class="line">        <span class="keyword">for</span> (int i = 0; i &lt; 3; i++) &#123;  </span><br><span class="line">            rgb[i] = random.nextInt(255);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="built_in">return</span> rgb;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    private static void shear(Graphics g, int w1, int h1, Color color) &#123;  </span><br><span class="line">        shearX(g, w1, h1, color);  </span><br><span class="line">        shearY(g, w1, h1, color);  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    private static void shearX(Graphics g, int w1, int h1, Color color) &#123;  </span><br><span class="line">  </span><br><span class="line">        int period = random.nextInt(2);  </span><br><span class="line">  </span><br><span class="line">        boolean borderGap = <span class="literal">true</span>;  </span><br><span class="line">        int frames = 1;  </span><br><span class="line">        int phase = random.nextInt(2);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">for</span> (int i = 0; i &lt; h1; i++) &#123;  </span><br><span class="line">            double d = (double) (period &gt;&gt; 1)  </span><br><span class="line">                    * Math.sin((double) i / (double) period  </span><br><span class="line">                            + (6.2831853071795862D * (double) phase)  </span><br><span class="line">                            / (double) frames);  </span><br><span class="line">            g.copyArea(0, i, w1, 1, (int) d, 0);  </span><br><span class="line">            <span class="keyword">if</span> (borderGap) &#123;  </span><br><span class="line">                g.setColor(color);  </span><br><span class="line">                g.drawLine((int) d, i, 0, i);  </span><br><span class="line">                g.drawLine((int) d + w1, i, w1, i);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    private static void shearY(Graphics g, int w1, int h1, Color color) &#123;  </span><br><span class="line">  </span><br><span class="line">        int period = random.nextInt(40) + 10; // 50;  </span><br><span class="line">  </span><br><span class="line">        boolean borderGap = <span class="literal">true</span>;  </span><br><span class="line">        int frames = 20;  </span><br><span class="line">        int phase = 7;  </span><br><span class="line">        <span class="keyword">for</span> (int i = 0; i &lt; w1; i++) &#123;  </span><br><span class="line">            double d = (double) (period &gt;&gt; 1)  </span><br><span class="line">                    * Math.sin((double) i / (double) period  </span><br><span class="line">                            + (6.2831853071795862D * (double) phase)  </span><br><span class="line">                            / (double) frames);  </span><br><span class="line">            g.copyArea(i, 0, 1, h1, 0, (int) d);  </span><br><span class="line">            <span class="keyword">if</span> (borderGap) &#123;  </span><br><span class="line">                g.setColor(color);  </span><br><span class="line">                g.drawLine(i, (int) d, i, 0);  </span><br><span class="line">                g.drawLine(i, (int) d + h1, i, h1);  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">    &lt;!-- 测试生成50张图片文件 --&gt;</span><br><span class="line">    public static void main(String[] args) throws IOException&#123;  </span><br><span class="line">        File dir = new File(<span class="string">"E:/verifies"</span>);  </span><br><span class="line">        int w = 200, h = 80;  </span><br><span class="line">        <span class="keyword">for</span>(int i = 0; i &lt; 50; i++)&#123;  </span><br><span class="line">            String verifyCode = generateVerifyCode(4);  </span><br><span class="line">            File file = new File(dir, verifyCode + <span class="string">".jpg"</span>);  </span><br><span class="line">            outputImage(w, h, file, verifyCode);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用servlet实现图片验证码"><a href="#使用servlet实现图片验证码" class="headerlink" title="使用servlet实现图片验证码"></a>使用servlet实现图片验证码</h3><p>web.xml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;servlet&gt;  </span><br><span class="line">    &lt;servlet-name&gt;AuthImage&lt;/servlet-name&gt;  </span><br><span class="line">    &lt;servlet-class&gt;com.utils.AuthImage&lt;/servlet-class&gt;  </span><br><span class="line">   &lt;/servlet&gt;</span><br><span class="line">   &lt;servlet-mapping&gt;  </span><br><span class="line">    &lt;servlet-name&gt;AuthImage&lt;/servlet-name&gt;  </span><br><span class="line">    &lt;url-pattern&gt;/authImage&lt;/url-pattern&gt;  </span><br><span class="line">&lt;/servlet-mapping&gt;  </span><br><span class="line">&lt;servlet-name&gt;ValidateImgCode&lt;/servlet-name&gt;  </span><br><span class="line">   	&lt;servlet-class&gt;com.utils.ValidateImgCode&lt;/servlet-class&gt;  </span><br><span class="line">   &lt;/servlet&gt;</span><br><span class="line">   &lt;servlet-mapping&gt;  </span><br><span class="line">    &lt;servlet-name&gt;ValidateImgCode&lt;/servlet-name&gt;  </span><br><span class="line">    &lt;url-pattern&gt;/validateImgCode&lt;/url-pattern&gt;  </span><br><span class="line">   &lt;/servlet-mapping&gt;</span><br></pre></td></tr></table></figure>
<p>生成验证码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">package com.utils;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">import javax.servlet.ServletException;</span><br><span class="line">import javax.servlet.http.HttpServletRequest;</span><br><span class="line">import javax.servlet.http.HttpServletResponse;</span><br><span class="line">import javax.servlet.http.HttpSession;</span><br><span class="line"></span><br><span class="line">public class AuthImage  extends javax.servlet.http.HttpServlet implements javax.servlet.Servlet&#123;</span><br><span class="line">	static final long serialVersionUID = 1L;  </span><br><span class="line">	  </span><br><span class="line">    public void service(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException &#123;  </span><br><span class="line">        response.setHeader(<span class="string">"Pragma"</span>, <span class="string">"No-cache"</span>);  </span><br><span class="line">        response.setHeader(<span class="string">"Cache-Control"</span>, <span class="string">"no-cache"</span>);  </span><br><span class="line">        response.setDateHeader(<span class="string">"Expires"</span>, 0);  </span><br><span class="line">        response.setContentType(<span class="string">"image/jpeg"</span>);  </span><br><span class="line">          </span><br><span class="line">        //生成随机字串  </span><br><span class="line">        String verifyCode = VerifyCodeUtils.generateVerifyCode(4);  </span><br><span class="line">        //存入会话session  </span><br><span class="line">        HttpSession session = request.getSession(<span class="literal">true</span>);  </span><br><span class="line">        session.setAttribute(<span class="string">"rand"</span>, verifyCode.toLowerCase());  </span><br><span class="line">        //生成图片  </span><br><span class="line">        int w = 200, h = 80;  </span><br><span class="line">        VerifyCodeUtils.outputImage(w, h, response.getOutputStream(), verifyCode);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>校验验证码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">package com.utils;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line">import javax.servlet.ServletException;</span><br><span class="line">import javax.servlet.http.HttpServlet;</span><br><span class="line">import javax.servlet.http.HttpServletRequest;</span><br><span class="line">import javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line">public class ValidateImgCode extends HttpServlet &#123;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * </span><br><span class="line">	 */</span><br><span class="line">	private static final long serialVersionUID = 1L;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void service(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException &#123;</span><br><span class="line">		// TODO Auto-generated method stub</span><br><span class="line">		response.setCharacterEncoding(<span class="string">"utf-8"</span>);</span><br><span class="line">		response.setContentType(<span class="string">"text/html;charset=utf-8"</span>);</span><br><span class="line">		PrintWriter out = response.getWriter();</span><br><span class="line">		</span><br><span class="line">		String code = (String)request.getSession().getAttribute(<span class="string">"rand"</span>);</span><br><span class="line">		String ImageCode = request.getParameter(<span class="string">"code"</span>);</span><br><span class="line">		<span class="keyword">if</span>(ImageCode.equals(code))&#123;</span><br><span class="line">			out.println(<span class="literal">true</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			out.println(<span class="literal">false</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用spring实现图片验证码"><a href="#使用spring实现图片验证码" class="headerlink" title="使用spring实现图片验证码"></a>使用spring实现图片验证码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">package com.utils;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">import javax.servlet.http.HttpServletRequest;</span><br><span class="line">import javax.servlet.http.HttpServletResponse;</span><br><span class="line">import javax.servlet.http.HttpSession;</span><br><span class="line"></span><br><span class="line">import org.springframework.stereotype.Controller;</span><br><span class="line">import org.springframework.util.StringUtils;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line">@Controller</span><br><span class="line">public class AuthImageSpring &#123;   </span><br><span class="line">	@RequestMapping(value=<span class="string">"/toImg"</span>)</span><br><span class="line">	public String <span class="function"><span class="title">toImg</span></span>()&#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">return</span> <span class="string">"image/image"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	 @RequestMapping(<span class="string">"/getSysManageLoginCode"</span>)</span><br><span class="line">	 @ResponseBody</span><br><span class="line">	 public String getSysManageLoginCode(HttpServletResponse response,</span><br><span class="line">	            HttpServletRequest request) &#123;</span><br><span class="line">		    response.setHeader(<span class="string">"Pragma"</span>, <span class="string">"No-cache"</span>);  </span><br><span class="line">	        response.setHeader(<span class="string">"Cache-Control"</span>, <span class="string">"no-cache"</span>);  </span><br><span class="line">	        response.setDateHeader(<span class="string">"Expires"</span>, 0);  </span><br><span class="line">	        response.setContentType(<span class="string">"image/jpeg"</span>);  </span><br><span class="line">	          </span><br><span class="line">	        //生成随机字串  </span><br><span class="line">	        String verifyCode = VerifyCodeUtils.generateVerifyCode(4);  </span><br><span class="line">	        //存入会话session  </span><br><span class="line">	        HttpSession session = request.getSession(<span class="literal">true</span>);  </span><br><span class="line">	        session.setAttribute(<span class="string">"rand"</span>, verifyCode.toLowerCase());  </span><br><span class="line">	        //生成图片 宽高 </span><br><span class="line">	        int w = 200, h = 80;  </span><br><span class="line">	        try &#123;</span><br><span class="line">				VerifyCodeUtils.outputImage(w, h, response.getOutputStream(), verifyCode);</span><br><span class="line">			&#125; catch (IOException e) &#123;</span><br><span class="line">				// TODO Auto-generated catch block</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;  </span><br><span class="line">	        <span class="built_in">return</span> <span class="string">""</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	 </span><br><span class="line">	 @RequestMapping(value = <span class="string">"/checkimagecode"</span>)</span><br><span class="line">	 @ResponseBody</span><br><span class="line">	 public String checkImageCode(HttpServletResponse response,</span><br><span class="line">	            HttpServletRequest request)&#123;</span><br><span class="line">		 String validateCode = request.getParameter(<span class="string">"code"</span>);</span><br><span class="line">		 String code = (String)request.getSession().getAttribute(<span class="string">"rand"</span>);</span><br><span class="line">	</span><br><span class="line">		</span><br><span class="line">	        <span class="keyword">if</span>(!StringUtils.isEmpty(validateCode) &amp;&amp; validateCode.equals(code))&#123;</span><br><span class="line">	            <span class="built_in">return</span> <span class="string">"ok"</span>;    </span><br><span class="line"></span><br><span class="line">	        &#125;</span><br><span class="line">	        <span class="built_in">return</span> <span class="string">"error"</span>;</span><br><span class="line">	</span><br><span class="line">	 &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
            </div>

			
            <section class="comment">
	
		
			<div id="disqus_thread">
			    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
			</div>
			<script type="text/javascript">

			(function() {

				 var uy = document.createElement('script');
				 uy.src = "//adminparry" + ".disqus.com/embed.js";

				 (document.getElementsByTagName('head')[0]
				 || document.getElementsByTagName('body')[0]).appendChild(uy);

			})();
		</script>
		
	
</section>


        </div>
    </div>
</article>


    <footer id="footer">
    	<br />
        <small>this blog power by <a href="https://hexo.io/" target="_blank">Hexo</a><br />
        <small>&copy; 2014 parry</small>
    </footer>

    
    <script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "https://hm.baidu.com/hm.js?e418ba3055c628bbdc7ef7f841b12ab8";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>




    
</body>
</html>

