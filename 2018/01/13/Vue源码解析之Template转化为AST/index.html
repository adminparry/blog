

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    
    <meta name="author" content="parry">
    
    <meta name="description" content="随着虚拟dom节点的盛行，从react出现之后，在Vue的mount过程中，template会被编译成AST语法树，AST是指抽象语法树（abstract syntax tree或者缩写为AST），或者语法树（syntax tree），是源代码的抽象语法结构的树状表现形式。
断点调试12345678">
    
    

    
    <link rel="alternative" href="YOUR_RSS_ADDRESS" title="parry" type="application/atom+xml">
    
    
    <link rel="icon" href="/blog/favicon.png">
    
    

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Vue源码解析之Template转化为AST | parry</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/blog/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/blog/css/style.css">

    <!-- Javascript -->
    <script src="/blog/js/jquery-2.1.0.min.js"></script>
    
    <script src="/blog/bootstrap/js/bootstrap.min.js"></script>

    <script src="/blog/js/common.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-inverse" role="banner">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a target="_blank" class="navbar-brand" href="http://code-helloworld.com" title="parry">parry</a>

            
            </div>

            <div role="navigation" class="collapse navbar-collapse bs-navbar-collapse">
                
                <a id="search" href="javascript:" class="navbar-text pull-right">搜索</a>
                <ul class="nav navbar-nav">
                    
                    <li id="nav-index"><a href="/blog">首页</a></li>
                    
                    <li id="nav-archives"><a href="/blog/archives">归档</a></li>
                    
                    
                    <li><a href="https://github.com/adminparry" target="_blank">GitHub</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div style="width:100%;height:100%;background:white;display:none;">
 
    </div>
    <script>
    var backRoot = "/blog/images/background/";
    var backArray = [ "1.jpg", "2.jpg", "3.jpg",  ];
        
    $(function() {
        // page-id...
        var pageId = "2018/01/13/Vue源码解析之Template转化为AST/";
        pageId = pageId.substr(0, pageId.indexOf("/"));
        if(pageId === "") pageId = "index";
        
        $("#nav-" + pageId).addClass("active");
        $('#search').click(function(){

        })
    });
    </script>

    <article class="post container">
    <div class="well post-body first-post last-post">
        <h1>Vue源码解析之Template转化为AST</h1>
        
        <div class="time-info">
发表于:<time datetime="2018-01-13T08:16:51.799Z" itemprop="datePublished">2018-01-13</time>，更新于:<time datetime="2018-01-26T03:57:27.319Z" itemprop="dateModified">2018-01-26</time>，By <a href="http://code-helloworld.com" title="parry">parry</a>
        </div>
        
        <div class="post-body-inner">
            <div id="toc" class="toc-article well">
                <strong class="toc-title">大纲</strong>
                <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#断点调试"><span class="toc-number">1.</span> <span class="toc-text">断点调试</span></a></li></ol>
            </div>
            <div class="description">

            <p>随着虚拟dom节点的盛行，从react出现之后，在Vue的mount过程中，template会被编译成AST语法树，AST是指抽象语法树（abstract syntax tree或者缩写为AST），或者语法树（syntax tree），是源代码的抽象语法结构的树状表现形式。</p>
<h3 id="断点调试"><a href="#断点调试" class="headerlink" title="断点调试"></a>断点调试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;title&gt;&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div id=<span class="string">"app"</span> class=<span class="string">"a"</span>&gt;</span><br><span class="line">   &#123;&#123;one&#125;&#125; + &#123;&#123;two&#125;&#125; = &#123;&#123;message&#125;&#125;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;script <span class="built_in">type</span>=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">  var app = new Vue(&#123;</span><br><span class="line">    el: <span class="string">'#app'</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">      one:1,</span><br><span class="line">      two:2,</span><br><span class="line">      message: <span class="string">'Hello Vue!'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    beforeCreate:<span class="function"><span class="title">function</span></span>()&#123;</span><br><span class="line">      console.log(<span class="string">'beforeCreate'</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    created:<span class="function"><span class="title">function</span></span>()&#123;</span><br><span class="line">      console.log(<span class="string">'created'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>首先进入_init原型方法<br><img src="/blog/images/vue/constructor.png" alt="constructor"><br>从中发现一个额外的事情 通过Object.defineProperty为原型上添加属性在原型中的this而其他的属性则加到对象的原型上</p>
<p><img src="/blog/images/vue/mergeOptions.png" alt="mergeOptions"><br>除了添加属性之外钩子函数终于出现了<br>我们可以穷举的进一下看看 发现还是添加属性<br>在这里不难发现顺序执行我们实例化vue函数所传参数的beforeCreate方法created方法<br>initRender为该函数转移了战场我们进去<br><img src="/blog/images/vue/initRender.png" alt="initRender"><br>initRender又把问题给了$mount<br><img src="/blog/images/vue/$mount.png" alt="$mount"><br>通过获取getOuterHTML<br>$mount把问题给了compileToFunctions<br><img src="/blog/images/vue/compileToFunctions.png" alt="compileToFunctions"><br>在这里做的事情比较多先进compile$$1看看<br><img src="/blog/images/vue/compile$$1.png" alt="compile$$1"><br>根据指引进compile$1<br><img src="/blog/images/vue/compile$1.png" alt="compile$1"><br>根据指引进parse<br><img src="/blog/images/vue/parse.png" alt="parse"><br>看来还得进parseHTML看看<br><img src="/blog/images/vue/parseHTML.png" alt="parseHTML"><br>一个while循环好像是在处理outerHMLT字符串 看看都动了什么手脚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br></pre></td><td class="code"><pre><span class="line">&lt;script <span class="built_in">type</span>=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line"><span class="keyword">function</span> parseHTML (html, options) &#123;</span><br><span class="line">  var stack = [];</span><br><span class="line">  var expectHTML = options.expectHTML;</span><br><span class="line">  var isUnaryTag$<span class="variable">$1</span> = options.isUnaryTag || no;</span><br><span class="line">  var index = 0;</span><br><span class="line">  var last, lastTag;</span><br><span class="line">  <span class="keyword">while</span> (html) &#123;</span><br><span class="line">    last = html;</span><br><span class="line">    // Make sure we<span class="string">'re not in a script or style element</span></span><br><span class="line"><span class="string">    if (!lastTag || !isSpecialTag(lastTag, options.sfc, stack)) &#123;</span></span><br><span class="line"><span class="string">      var textEnd = html.indexOf('</span>&lt;<span class="string">');</span></span><br><span class="line"><span class="string">      if (textEnd === 0) &#123;</span></span><br><span class="line"><span class="string">        // Comment:</span></span><br><span class="line"><span class="string">        if (comment.test(html)) &#123;</span></span><br><span class="line"><span class="string">          var commentEnd = html.indexOf('</span>--&gt;<span class="string">');</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">          if (commentEnd &gt;= 0) &#123;</span></span><br><span class="line"><span class="string">            advance(commentEnd + 3);</span></span><br><span class="line"><span class="string">            continue</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        // http://en.wikipedia.org/wiki/Conditional_comment#Downlevel-revealed_conditional_comment</span></span><br><span class="line"><span class="string">        if (conditionalComment.test(html)) &#123;</span></span><br><span class="line"><span class="string">          var conditionalEnd = html.indexOf('</span>]&gt;<span class="string">');</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">          if (conditionalEnd &gt;= 0) &#123;</span></span><br><span class="line"><span class="string">            advance(conditionalEnd + 2);</span></span><br><span class="line"><span class="string">            continue</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        // Doctype:</span></span><br><span class="line"><span class="string">        var doctypeMatch = html.match(doctype);</span></span><br><span class="line"><span class="string">        if (doctypeMatch) &#123;</span></span><br><span class="line"><span class="string">          advance(doctypeMatch[0].length);</span></span><br><span class="line"><span class="string">          continue</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        // End tag:</span></span><br><span class="line"><span class="string">        var endTagMatch = html.match(endTag);</span></span><br><span class="line"><span class="string">        if (endTagMatch) &#123;</span></span><br><span class="line"><span class="string">          var curIndex = index;</span></span><br><span class="line"><span class="string">          advance(endTagMatch[0].length);</span></span><br><span class="line"><span class="string">          parseEndTag(endTagMatch[0], endTagMatch[1], curIndex, index);</span></span><br><span class="line"><span class="string">          continue</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        // Start tag:</span></span><br><span class="line"><span class="string">        var startTagMatch = parseStartTag();</span></span><br><span class="line"><span class="string">        if (startTagMatch) &#123;</span></span><br><span class="line"><span class="string">          handleStartTag(startTagMatch);</span></span><br><span class="line"><span class="string">          continue</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      var text = (void 0), rest$1 = (void 0), next = (void 0);</span></span><br><span class="line"><span class="string">      if (textEnd &gt; 0) &#123;</span></span><br><span class="line"><span class="string">        rest$1 = html.slice(textEnd);</span></span><br><span class="line"><span class="string">        while (</span></span><br><span class="line"><span class="string">          !endTag.test(rest$1) &amp;&amp;</span></span><br><span class="line"><span class="string">          !startTagOpen.test(rest$1) &amp;&amp;</span></span><br><span class="line"><span class="string">          !comment.test(rest$1) &amp;&amp;</span></span><br><span class="line"><span class="string">          !conditionalComment.test(rest$1)</span></span><br><span class="line"><span class="string">        ) &#123;</span></span><br><span class="line"><span class="string">          // &lt; in plain text, be forgiving and treat it as text</span></span><br><span class="line"><span class="string">          next = rest$1.indexOf('</span>&lt;<span class="string">', 1);</span></span><br><span class="line"><span class="string">          if (next &lt; 0) &#123; break &#125;</span></span><br><span class="line"><span class="string">          textEnd += next;</span></span><br><span class="line"><span class="string">          rest$1 = html.slice(textEnd);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        text = html.substring(0, textEnd);</span></span><br><span class="line"><span class="string">        advance(textEnd);</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      if (textEnd &lt; 0) &#123;</span></span><br><span class="line"><span class="string">        text = html;</span></span><br><span class="line"><span class="string">        html = '</span><span class="string">';</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      if (options.chars &amp;&amp; text) &#123;</span></span><br><span class="line"><span class="string">        options.chars(text);</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125; else &#123;</span></span><br><span class="line"><span class="string">      var stackedTag = lastTag.toLowerCase();</span></span><br><span class="line"><span class="string">      var reStackedTag = reCache[stackedTag] || (reCache[stackedTag] = new RegExp('</span>([\\s\\S]*?)(&lt;/<span class="string">' + stackedTag + '</span>[^&gt;]*&gt;)<span class="string">', '</span>i<span class="string">'));</span></span><br><span class="line"><span class="string">      var endTagLength = 0;</span></span><br><span class="line"><span class="string">      var rest = html.replace(reStackedTag, function (all, text, endTag) &#123;</span></span><br><span class="line"><span class="string">        endTagLength = endTag.length;</span></span><br><span class="line"><span class="string">        if (stackedTag !== '</span>script<span class="string">' &amp;&amp; stackedTag !== '</span>style<span class="string">' &amp;&amp; stackedTag !== '</span>noscript<span class="string">') &#123;</span></span><br><span class="line"><span class="string">          text = text</span></span><br><span class="line"><span class="string">            .replace(/&lt;!--([\s\S]*?)--&gt;/g, '</span><span class="variable">$1</span><span class="string">')</span></span><br><span class="line"><span class="string">            .replace(/&lt;!\[CDATA\[([\s\S]*?)]]&gt;/g, '</span><span class="variable">$1</span><span class="string">');</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        if (options.chars) &#123;</span></span><br><span class="line"><span class="string">          options.chars(text);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        return '</span><span class="string">'</span></span><br><span class="line"><span class="string">      &#125;);</span></span><br><span class="line"><span class="string">      index += html.length - rest.length;</span></span><br><span class="line"><span class="string">      html = rest;</span></span><br><span class="line"><span class="string">      parseEndTag('</span>&lt;/<span class="string">' + stackedTag + '</span>&gt;<span class="string">', stackedTag, index - endTagLength, index);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    if (html === last &amp;&amp; options.chars) &#123;</span></span><br><span class="line"><span class="string">      options.chars(html);</span></span><br><span class="line"><span class="string">      break</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  // Clean up any remaining tags</span></span><br><span class="line"><span class="string">  parseEndTag();</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  function advance (n) &#123;</span></span><br><span class="line"><span class="string">    index += n;</span></span><br><span class="line"><span class="string">    html = html.substring(n);</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  function parseStartTag () &#123;</span></span><br><span class="line"><span class="string">    var start = html.match(startTagOpen);</span></span><br><span class="line"><span class="string">    if (start) &#123;</span></span><br><span class="line"><span class="string">      var match = &#123;</span></span><br><span class="line"><span class="string">        tagName: start[1],</span></span><br><span class="line"><span class="string">        attrs: [],</span></span><br><span class="line"><span class="string">        start: index</span></span><br><span class="line"><span class="string">      &#125;;</span></span><br><span class="line"><span class="string">      advance(start[0].length);</span></span><br><span class="line"><span class="string">      var end, attr;</span></span><br><span class="line"><span class="string">      while (!(end = html.match(startTagClose)) &amp;&amp; (attr = html.match(attribute))) &#123;</span></span><br><span class="line"><span class="string">        advance(attr[0].length);</span></span><br><span class="line"><span class="string">        match.attrs.push(attr);</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      if (end) &#123;</span></span><br><span class="line"><span class="string">        match.unarySlash = end[1];</span></span><br><span class="line"><span class="string">        advance(end[0].length);</span></span><br><span class="line"><span class="string">        match.end = index;</span></span><br><span class="line"><span class="string">        return match</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  function handleStartTag (match) &#123;</span></span><br><span class="line"><span class="string">    var tagName = match.tagName;</span></span><br><span class="line"><span class="string">    var unarySlash = match.unarySlash;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    if (expectHTML) &#123;</span></span><br><span class="line"><span class="string">      if (lastTag === '</span>p<span class="string">' &amp;&amp; isNonPhrasingTag(tagName)) &#123;</span></span><br><span class="line"><span class="string">        parseEndTag('</span><span class="string">', lastTag);</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      if (canBeLeftOpenTag(tagName) &amp;&amp; lastTag === tagName) &#123;</span></span><br><span class="line"><span class="string">        parseEndTag('</span><span class="string">', tagName);</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    var unary = isUnaryTag$$1(tagName) || tagName === '</span>html<span class="string">' &amp;&amp; lastTag === '</span>head<span class="string">' || !!unarySlash;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    var l = match.attrs.length;</span></span><br><span class="line"><span class="string">    var attrs = new Array(l);</span></span><br><span class="line"><span class="string">    for (var i = 0; i &lt; l; i++) &#123;</span></span><br><span class="line"><span class="string">      var args = match.attrs[i];</span></span><br><span class="line"><span class="string">      // hackish work around FF bug https://bugzilla.mozilla.org/show_bug.cgi?id=369778</span></span><br><span class="line"><span class="string">      if (IS_REGEX_CAPTURING_BROKEN &amp;&amp; args[0].indexOf('</span><span class="string">""</span><span class="string">') === -1) &#123;</span></span><br><span class="line"><span class="string">        if (args[3] === '</span><span class="string">') &#123; delete args[3]; &#125;</span></span><br><span class="line"><span class="string">        if (args[4] === '</span><span class="string">') &#123; delete args[4]; &#125;</span></span><br><span class="line"><span class="string">        if (args[5] === '</span><span class="string">') &#123; delete args[5]; &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      var value = args[3] || args[4] || args[5] || '</span><span class="string">';</span></span><br><span class="line"><span class="string">      attrs[i] = &#123;</span></span><br><span class="line"><span class="string">        name: args[1],</span></span><br><span class="line"><span class="string">        value: decodeAttr(</span></span><br><span class="line"><span class="string">          value,</span></span><br><span class="line"><span class="string">          options.shouldDecodeNewlines</span></span><br><span class="line"><span class="string">        )</span></span><br><span class="line"><span class="string">      &#125;;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    if (!unary) &#123;</span></span><br><span class="line"><span class="string">      stack.push(&#123; tag: tagName, attrs: attrs &#125;);</span></span><br><span class="line"><span class="string">      lastTag = tagName;</span></span><br><span class="line"><span class="string">      unarySlash = '</span><span class="string">';</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    if (options.start) &#123;</span></span><br><span class="line"><span class="string">      options.start(tagName, attrs, unary, match.start, match.end);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  function parseEndTag (tag, tagName, start, end) &#123;</span></span><br><span class="line"><span class="string">    var pos;</span></span><br><span class="line"><span class="string">    if (start == null) &#123; start = index; &#125;</span></span><br><span class="line"><span class="string">    if (end == null) &#123; end = index; &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // Find the closest opened tag of the same type</span></span><br><span class="line"><span class="string">    if (tagName) &#123;</span></span><br><span class="line"><span class="string">      var needle = tagName.toLowerCase();</span></span><br><span class="line"><span class="string">      for (pos = stack.length - 1; pos &gt;= 0; pos--) &#123;</span></span><br><span class="line"><span class="string">        if (stack[pos].tag.toLowerCase() === needle) &#123;</span></span><br><span class="line"><span class="string">          break</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125; else &#123;</span></span><br><span class="line"><span class="string">      // If no tag name is provided, clean shop</span></span><br><span class="line"><span class="string">      pos = 0;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    if (pos &gt;= 0) &#123;</span></span><br><span class="line"><span class="string">      // Close all the open elements, up the stack</span></span><br><span class="line"><span class="string">      for (var i = stack.length - 1; i &gt;= pos; i--) &#123;</span></span><br><span class="line"><span class="string">        if (options.end) &#123;</span></span><br><span class="line"><span class="string">          options.end(stack[i].tag, start, end);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      // Remove the open elements from the stack</span></span><br><span class="line"><span class="string">      stack.length = pos;</span></span><br><span class="line"><span class="string">      lastTag = pos &amp;&amp; stack[pos - 1].tag;</span></span><br><span class="line"><span class="string">    &#125; else if (tagName.toLowerCase() === '</span>br<span class="string">') &#123;</span></span><br><span class="line"><span class="string">      if (options.start) &#123;</span></span><br><span class="line"><span class="string">        options.start(tagName, [], true, start, end);</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125; else if (tagName.toLowerCase() === '</span>p<span class="string">') &#123;</span></span><br><span class="line"><span class="string">      if (options.start) &#123;</span></span><br><span class="line"><span class="string">        options.start(tagName, [], false, start, end);</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      if (options.end) &#123;</span></span><br><span class="line"><span class="string">        options.end(tagName, start, end);</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;script <span class="built_in">type</span>=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">在我这里我首先进入的是 parseStartTag</span><br><span class="line">html.indexOf(<span class="string">'&lt;'</span>);先判断&lt;符号的索引等于0 然后大于0</span><br><span class="line">如果是&#123;&#123;&#125;&#125;表达式的文本节点</span><br><span class="line">搞了个对象</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">type</span>: 2,</span><br><span class="line">  expression: <span class="string">""</span>\n   <span class="string">"+_s(one)+"</span> + <span class="string">"+_s(two)+"</span> \n<span class="string">""</span>,</span><br><span class="line">  text: <span class="string">"</span></span><br><span class="line"><span class="string">   &#123;&#123;one&#125;&#125; + &#123;&#123;two&#125;&#125; </span></span><br><span class="line"><span class="string">"</span></span><br><span class="line">&#125;</span><br><span class="line">![parseStartTag](/blog/images/vue/parseStartTag.png)</span><br><span class="line">搞了个对象</span><br><span class="line">&#123;</span><br><span class="line">  tagName: <span class="string">'div'</span>,</span><br><span class="line">  attrs: [[<span class="string">'id=app'</span>,<span class="string">'id'</span>,<span class="string">'='</span>,<span class="string">'app'</span>],[<span class="string">'class=a'</span>,<span class="string">'class'</span>,<span class="string">'='</span>,<span class="string">'a'</span>]],</span><br><span class="line">  end:24,</span><br><span class="line">  start:0</span><br><span class="line">  unarySlash: <span class="string">''</span></span><br><span class="line">&#125;</span><br><span class="line">然后转换了一下</span><br><span class="line">&#123;</span><br><span class="line">attrsMap:&#123;class:<span class="string">'a'</span>,id:<span class="string">'app'</span>&#125;,</span><br><span class="line">children:[&#123;</span><br><span class="line">  <span class="built_in">type</span>: 2,</span><br><span class="line">  expression: <span class="string">""</span>\n   <span class="string">"+_s(one)+"</span> + <span class="string">"+_s(two)+"</span> \n<span class="string">""</span>,</span><br><span class="line">  text: <span class="string">"</span></span><br><span class="line"><span class="string">   &#123;&#123;one&#125;&#125; + &#123;&#123;two&#125;&#125; </span></span><br><span class="line"><span class="string">"</span></span><br><span class="line">&#125;]</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>有几段正则拿出来看看<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;script <span class="built_in">type</span>=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line"></span><br><span class="line">  var ncname = <span class="string">'[a-zA-Z_][\\w\\-\\.]*'</span>;</span><br><span class="line">  var qnameCapture = <span class="string">'((?:'</span> + ncname + <span class="string">'\\:)?'</span> + ncname + <span class="string">')'</span>;</span><br><span class="line">  var startTagOpen = new RegExp(<span class="string">'^&lt;'</span> + qnameCapture);</span><br><span class="line"></span><br><span class="line">  var startTagClose = /^\s*(\/?)&gt;/;</span><br><span class="line"></span><br><span class="line">  var singleAttrIdentifier = /([^\s<span class="string">"'&lt;&gt;/=]+)/;</span></span><br><span class="line"><span class="string">  var singleAttrAssign = /(?:=)/;</span></span><br><span class="line"><span class="string">  var singleAttrValues = [</span></span><br><span class="line"><span class="string">    // attr value double quotes</span></span><br><span class="line"><span class="string">    /"</span>([^<span class="string">"]*)"</span>+/.<span class="built_in">source</span>,</span><br><span class="line">    // attr value, single quotes</span><br><span class="line">    /<span class="string">'([^'</span>]*)<span class="string">'+/.source,</span></span><br><span class="line"><span class="string">    // attr value, no quotes</span></span><br><span class="line"><span class="string">    /([^\s"'</span>=&lt;&gt;`]+)/.<span class="built_in">source</span></span><br><span class="line">  ];</span><br><span class="line">  var attribute = new RegExp(</span><br><span class="line">    <span class="string">'^\\s*'</span> + singleAttrIdentifier.source +</span><br><span class="line">    <span class="string">'(?:\\s*('</span> + singleAttrAssign.source + <span class="string">')'</span> +</span><br><span class="line">    <span class="string">'\\s*(?:'</span> + singleAttrValues.join(<span class="string">'|'</span>) + <span class="string">'))?'</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  var defaultTagRE = /\&#123;\&#123;((?:.|\n)+?)\&#125;\&#125;/g;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></p>
<p>然后回到了compile$1<br>{<br>render:”with(this){return _h(‘div’,{staticClass:”a”,attrs:{“id”:”app”}},[“\n   “+_s(one)+” + “+_s(two)+” \n”])}”,<br>staticRenderFns:[]<br>}<br>回到compileToFunctions回到$mount执行mount方法然后执行原型_mount方法</p>
<p><img src="/blog/images/vue/p_mount.png" alt="_mount"></p>
<p>然后执行原型方法_render和_update _watcher<br><img src="/blog/images/vue/p_render.png" alt="_render"></p>
<p><img src="/blog/images/vue/p_update.png" alt="_update"></p>
<p>在这里不难发现顺序执行我们实例化vue函数所传参数的beforeMount方法</p>
<p><a href="https://segmentfault.com/a/1190000011531094" target="_blank" rel="noopener">https://segmentfault.com/a/1190000011531094</a></p>

            </div>

			
            <section class="comment">

this is a comment
<!-- UY BEGIN -->
  <div id="uyan_frame"></div>
  <script src="http://v2.uyan.cc/code/uyan.js?uid=2156610"></script>
<!-- UY END -->
</section>
        </div>
    </div>
</article>

    <footer id="footer">
    	<br />
        <small>this blog power by <a href="https://hexo.io/" target="_blank">Hexo</a><br />
        <small>&copy; 2014 parry</small>
    </footer>

    


</body>
</html>

